---
import { Icon } from 'astro-icon/components';
---

<nav class="w-full flex justify-center print:hidden">
  <div class="w-full max-w-5xl flex justify-between items-center px-6 sm:px-8 py-4 text-stone-500 dark:text-stone-400">
    <div class="flex items-center">
      <button onclick="window.history.back()" class="flex items-center justify-center w-8 h-8 -ml-2 hover:text-stone-900 dark:hover:text-stone-100 transition-colors duration-300 outline-none focus-visible:ring-2 focus-visible:ring-stone-400 rounded-md">
        <Icon name="lucide:chevron-left" class="w-5 h-5" />
      </button>
    </div>
    
    <div class="flex items-center gap-6">
      <div class="relative dropdown flex items-center">
        <button id="theme-btn" class="text-xs hover:text-stone-900 dark:hover:text-stone-100 transition-colors duration-300 outline-none focus-visible:ring-2 focus-visible:ring-stone-400 rounded-md">
          <Icon name="lucide:sun" class="dark:hidden w-5 h-5" />
          <Icon name="lucide:moon" class="hidden dark:inline w-5 h-5" />
        </button>
        <div id="theme-menu" class="menu-content absolute right-0 top-full mt-3 w-32 bg-white dark:bg-stone-950 border border-stone-200 dark:border-stone-800 py-1 z-50 shadow-lg transition-[opacity,transform,visibility] duration-300 ease-out origin-top-right opacity-0 scale-95 invisible pointer-events-none">
          <button data-theme="light" class="w-full text-left px-3 py-2 text-[13px] font-medium text-stone-600 dark:text-stone-300 hover:text-stone-900 dark:hover:text-stone-100 hover:bg-stone-50 dark:hover:bg-stone-900 transition-colors duration-200">Light</button>
          <button data-theme="dark" class="w-full text-left px-3 py-2 text-[13px] font-medium text-stone-600 dark:text-stone-300 hover:text-stone-900 dark:hover:text-stone-100 hover:bg-stone-50 dark:hover:bg-stone-900 transition-colors duration-200">Dark</button>
          <button data-theme="system" class="w-full text-left px-3 py-2 text-[13px] font-medium text-stone-600 dark:text-stone-300 hover:text-stone-900 dark:hover:text-stone-100 hover:bg-stone-50 dark:hover:bg-stone-900 border-t border-stone-100 dark:border-stone-900 mt-1 transition-colors duration-200">System</button>
        </div>
      </div>

      <div class="relative dropdown flex items-center">
        <button id="lang-btn" class="text-xs font-bold hover:text-stone-900 dark:hover:text-stone-100 transition-colors duration-300 outline-none focus-visible:ring-2 focus-visible:ring-stone-400 rounded-md">
          <Icon name="lucide:languages" class="w-5 h-5" />
        </button>
        <div id="lang-menu" class="menu-content absolute right-0 top-full mt-3 w-28 bg-white dark:bg-stone-950 border border-stone-200 dark:border-stone-800 py-1 z-50 shadow-lg transition-[opacity,transform,visibility] duration-300 ease-out origin-top-right opacity-0 scale-95 invisible pointer-events-none">
          <button data-lang="ko" class="w-full text-left px-3 py-2 text-[13px] font-medium text-stone-600 dark:text-stone-300 hover:text-stone-900 dark:hover:text-stone-100 hover:bg-stone-50 dark:hover:bg-stone-900 transition-colors duration-200">한국어</button>
          <button data-lang="en" class="w-full text-left px-3 py-2 text-[13px] font-medium text-stone-600 dark:text-stone-300 hover:text-stone-900 dark:hover:text-stone-100 hover:bg-stone-50 dark:hover:bg-stone-900 transition-colors duration-200">English</button>
        </div>
      </div>
    </div>
  </div>
</nav>

<style is:global>
  *, *::before, *::after {
    transition-property: color, background-color, border-color, text-decoration-color, fill, stroke;
    transition-timing-function: ease-in-out;
    transition-duration: 500ms;
  }
  
  html.dark, html.dark body {
    transition: background-color 0.5s ease-in-out;
  }

  .dropdown-open {
    opacity: 1 !important;
    transform: scale(1) !important;
    visibility: visible !important;
    pointer-events: auto !important;
  }
</style>

<script is:inline>
  function setupNavbar() {
    const themeBtn = document.getElementById('theme-btn');
    const themeMenu = document.getElementById('theme-menu');
    const langBtn = document.getElementById('lang-btn');
    const langMenu = document.getElementById('lang-menu');
    const openClass = 'dropdown-open';

    if (!themeBtn || !themeMenu || !langBtn || !langMenu) return;

    const toggle = (m, o) => { o.classList.remove(openClass); m.classList.toggle(openClass); };
    
    themeBtn.onclick = (e) => { e.stopPropagation(); toggle(themeMenu, langMenu); };
    langBtn.onclick = (e) => { e.stopPropagation(); toggle(langMenu, themeMenu); };
    
    document.onclick = () => { 
      themeMenu.classList.remove(openClass); 
      langMenu.classList.remove(openClass); 
    };

    document.querySelectorAll('[data-theme]').forEach(btn => {
      btn.onclick = (e) => {
        const theme = e.currentTarget.getAttribute('data-theme');
        localStorage.setItem('theme', theme);
        
        const isDark = theme === 'dark' || (theme === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches);
        
        requestAnimationFrame(() => {
          document.documentElement.classList.toggle('dark', isDark);
        });

        themeMenu.classList.remove(openClass);
      };
    });

    document.querySelectorAll('[data-lang]').forEach(btn => {
      btn.onclick = (e) => {
        const targetLang = e.currentTarget.getAttribute('data-lang');
        const segments = window.location.pathname.split('/').filter(Boolean);
        if (segments[0] === 'ko' || segments[0] === 'en') {
          segments[0] = targetLang;
        } else {
          segments.unshift(targetLang);
        }
        window.location.href = '/' + segments.join('/');
      };
    });
  }

  setupNavbar();
  document.addEventListener('astro:after-swap', setupNavbar);
</script>